<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>krotov.parallelization module &mdash; Krotov 1.3.0+dev (341cb5c) documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d75fae25" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" href="../_static/mycss.css" type="text/css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=2624feb1"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script src="../_static/docs-versions-menu.js?v=3d6a1aea"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"extensions": ["tex2jax.js"], "jax": ["input/TeX", "output/SVG"], "TeX": {"extensions": ["AMSmath.js", "AMSsymbols.js"], "Macros": {"tr": ["{\\operatorname{tr}}", 0], "diag": ["{\\operatorname{diag}}", 0], "abs": ["{\\operatorname{abs}}", 0], "pop": ["{\\operatorname{pop}}", 0], "ee": ["{\\text{e}}", 0], "ii": ["{\\text{i}}", 0], "aux": ["{\\text{aux}}", 0], "opt": ["{\\text{opt}}", 0], "tgt": ["{\\text{tgt}}", 0], "init": ["{\\text{init}}", 0], "lab": ["{\\text{lab}}", 0], "rwa": ["{\\text{rwa}}", 0], "bra": ["{\\langle#1\\vert}", 1], "ket": ["{\\vert#1\\rangle}", 1], "Bra": ["{\\left\\langle#1\\right\\vert}", 1], "Braket": ["{\\left\\langle #1\\vphantom{#2} \\mid #2\\vphantom{#1}\\right\\rangle}", 2], "ketbra": ["{\\vert#1\\rangle\\!\\langle#2\\vert}", 2], "Ket": ["{\\left\\vert#1\\right\\rangle}", 1], "mat": ["{\\mathbf{#1}}", 1], "op": ["{\\hat{#1}}", 1], "Op": ["{\\hat{#1}}", 1], "dd": ["{\\,\\text{d}}", 0], "daggered": ["{^{\\dagger}}", 0], "transposed": ["{^{\\text{T}}}", 0], "Liouville": ["{\\mathcal{L}}", 0], "DynMap": ["{\\mathcal{E}}", 0], "identity": ["{\\mathbf{1}}", 0], "Norm": ["{\\left\\lVert#1\\right\\rVert}", 1], "norm": ["{\\lVert#1\\rVert}", 1], "Abs": ["{\\left\\vert#1\\right\\vert}", 1], "avg": ["{\\langle#1\\rangle}", 1], "Avg": ["{\\left\\langle#1\\right\\rangle}", 1], "AbsSq": ["{\\left\\vert#1\\right\\vert^2}", 1], "Re": ["{\\operatorname{Re}}", 0], "Im": ["{\\operatorname{Im}}", 0], "Real": ["{\\mathbb{R}}", 0], "Complex": ["{\\mathbb{C}}", 0], "Integer": ["{\\mathbb{N}}", 0]}}, "tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="krotov.propagators module" href="krotov.propagators.html" />
    <link rel="prev" title="krotov.optimize module" href="krotov.optimize.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Krotov
          </a>
              <div class="version">
                1.3.0+dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../01_overview.html">Krotov Python Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06_introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07_krotovs_method.html">Krotov’s Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08_qutip_usage.html">Using Krotov with QuTiP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10_howto.html">How-Tos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11_other_methods.html">Other Optimization Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../12_related_software.html">Related Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../99_bibliography.html">References</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="krotov.html">API of the Krotov package</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="krotov.convergence.html">krotov.convergence module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.conversions.html">krotov.conversions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.functionals.html">krotov.functionals module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.info_hooks.html">krotov.info_hooks module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.mu.html">krotov.mu module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.objectives.html">krotov.objectives module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.optimize.html">krotov.optimize module</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">krotov.parallelization module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reference">Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#krotov.parallelization.set_parallelization"><code class="docutils literal notranslate"><span class="pre">set_parallelization()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#krotov.parallelization.parallel_map"><code class="docutils literal notranslate"><span class="pre">parallel_map()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#krotov.parallelization.Consumer"><code class="docutils literal notranslate"><span class="pre">Consumer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#krotov.parallelization.FwPropStepTask"><code class="docutils literal notranslate"><span class="pre">FwPropStepTask</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#krotov.parallelization.parallel_map_fw_prop_step"><code class="docutils literal notranslate"><span class="pre">parallel_map_fw_prop_step()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#krotov.parallelization.USE_LOKY"><code class="docutils literal notranslate"><span class="pre">USE_LOKY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#krotov.parallelization.USE_THREADPOOL_LIMITS"><code class="docutils literal notranslate"><span class="pre">USE_THREADPOOL_LIMITS</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="krotov.propagators.html">krotov.propagators module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.result.html">krotov.result module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.second_order.html">krotov.second_order module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.shapes.html">krotov.shapes module</a></li>
<li class="toctree-l2"><a class="reference internal" href="krotov.html#summary">Summary</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Krotov</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          



























<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="krotov.html">krotov package</a> &raquo;</li>
        
      <li>krotov.parallelization module</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-krotov.parallelization">
<span id="krotov-parallelization-module"></span><h1>krotov.parallelization module<a class="headerlink" href="#module-krotov.parallelization" title="Link to this heading">¶</a></h1>
<p>Support routines for running the optimization in parallel across the
objectives.</p>
<p>The time-propagation that is the main numerical effort in an optimization with
Krotov’s method can naturally be performed in parallel for the different
objectives. There are three time-propagations that happen inside
<a class="reference internal" href="krotov.optimize.html#krotov.optimize.optimize_pulses" title="krotov.optimize.optimize_pulses"><code class="xref py py-func docutils literal notranslate"><span class="pre">optimize_pulses()</span></code></a>:</p>
<ol class="arabic simple">
<li><p>A forward propagation of the <a class="reference internal" href="krotov.objectives.html#krotov.objectives.Objective.initial_state" title="krotov.objectives.Objective.initial_state"><code class="xref py py-attr docutils literal notranslate"><span class="pre">initial_state</span></code></a> of each
objective under the initial guess pulse.</p></li>
<li><p>A backward propagation of the states <span class="math notranslate nohighlight">\(\ket{\chi_k}\)</span> constructed by the
<cite>chi_constructor</cite> routine that is passed to <a class="reference internal" href="krotov.optimize.html#krotov.optimize.optimize_pulses" title="krotov.optimize.optimize_pulses"><code class="xref py py-func docutils literal notranslate"><span class="pre">optimize_pulses()</span></code></a>, where
the number of states is the same as the number of objectives.</p></li>
<li><p>A forward propagation of the <a class="reference internal" href="krotov.objectives.html#krotov.objectives.Objective.initial_state" title="krotov.objectives.Objective.initial_state"><code class="xref py py-attr docutils literal notranslate"><span class="pre">initial_state</span></code></a> of each
objective under the optimized pulse in each iteration. This can only
be parallelized <em>per time step</em>, as the propagated states from each time
step collectively determine the pulse update for the next time step, which
is then used for the next propagation step. (In this sense Krotov’s method
is “sequential”)</p></li>
</ol>
<p>The <a class="reference internal" href="krotov.optimize.html#krotov.optimize.optimize_pulses" title="krotov.optimize.optimize_pulses"><code class="xref py py-func docutils literal notranslate"><span class="pre">optimize_pulses()</span></code></a> routine has a parameter <cite>parallel_map</cite> that can
receive a tuple of three “map” functions to enable parallelization,
corresponding to the three propagation listed above. If not given,
<a class="reference external" href="https://qutip.org/docs/4.5/apidoc/functions.html#qutip.parallel.serial_map" title="(in QuTiP: Quantum Toolbox in Python v4.5)"><code class="xref py py-func docutils literal notranslate"><span class="pre">qutip.parallel.serial_map()</span></code></a> is used for all three propagations, running
in serial. Any alternative “map” must have the same interface as
<a class="reference external" href="https://qutip.org/docs/4.5/apidoc/functions.html#qutip.parallel.serial_map" title="(in QuTiP: Quantum Toolbox in Python v4.5)"><code class="xref py py-func docutils literal notranslate"><span class="pre">qutip.parallel.serial_map()</span></code></a>.</p>
<p>It would be natural to assume that <a class="reference external" href="https://qutip.org/docs/4.5/apidoc/functions.html#qutip.parallel.parallel_map" title="(in QuTiP: Quantum Toolbox in Python v4.5)"><code class="xref py py-func docutils literal notranslate"><span class="pre">qutip.parallel.parallel_map()</span></code></a>
respectively the slightly improved <a class="reference internal" href="#krotov.parallelization.parallel_map" title="krotov.parallelization.parallel_map"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallel_map()</span></code></a> provided in this module
would be a good choice for parallel execution, using multiple CPUs on the same
machine.  However, this function is only a good choice for the propagation (1)
and (2): these run in parallel over the entire time grid without any
communication, and thus minimal overhead.  However, this is not true for the
propagation (3), which must synchronize after each time step. In that case, the
“naive” use of <a class="reference external" href="https://qutip.org/docs/4.5/apidoc/functions.html#qutip.parallel.parallel_map" title="(in QuTiP: Quantum Toolbox in Python v4.5)"><code class="xref py py-func docutils literal notranslate"><span class="pre">qutip.parallel.parallel_map()</span></code></a> results in a communication
overhead that completely dominates the propagation, and actually makes the
optimization slower (potentially by more than an order of magnitude).</p>
<p>The function <a class="reference internal" href="#krotov.parallelization.parallel_map_fw_prop_step" title="krotov.parallelization.parallel_map_fw_prop_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallel_map_fw_prop_step()</span></code></a> provided in this module is an
appropriate alternative implementation that uses long-running processes,
internal caching, and minimal inter-process communication to eliminate the
communication overhead as much as possible. However, the internal caching is
valid only under the assumption that the <cite>propagate</cite> function does not have
side effects.</p>
<p>In general,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parallel_map</span><span class="o">=</span><span class="p">(</span>
    <span class="n">krotov</span><span class="o">.</span><span class="n">parallelization</span><span class="o">.</span><span class="n">parallel_map</span><span class="p">,</span>
    <span class="n">krotov</span><span class="o">.</span><span class="n">parallelization</span><span class="o">.</span><span class="n">parallel_map</span><span class="p">,</span>
    <span class="n">krotov</span><span class="o">.</span><span class="n">parallelization</span><span class="o">.</span><span class="n">parallel_map_fw_prop_step</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>is a decent choice for enabling parallelization for a typical multi-objective
optimization (but don’t expect wonders: general pure-python parallelization is
an unsolved problem.)</p>
<p>You may implement your own “map” functions to exploit parallelization paradigms
other than Python’s built-in <a class="reference external" href="https://docs.python.org/3.7/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multiprocessing</span></code></a>, provided here. This
includes distributed propagation, e.g. through <a class="reference external" href="https://ipyparallel.readthedocs.io/en/latest/">ipyparallel</a> clusters. To write
your own <cite>parallel_map</cite> functions, review the source code of
<a class="reference internal" href="krotov.optimize.html#krotov.optimize.optimize_pulses" title="krotov.optimize.optimize_pulses"><code class="xref py py-func docutils literal notranslate"><span class="pre">optimize_pulses()</span></code></a> in detail.</p>
<p>In most cases, it will be difficult to obtain a linear speedup from
parallelization: even with carefully tuned manual interprocess communication,
the communication overhead can be substantial. For best results, it would be
necessary to use <cite>parallel_map</cite> functions implemented in Cython, where the GIL
can be released and the entire propagation (and storage of propagated states)
can be done in shared-memory with no overhead.</p>
<p>Also note that the overhead of multi-process parallelization is
platform-dependent. On Linux, subprocesses are “forked” which causes them to
inherit the current state of the parent process without any explicit (and
expensive) inter-process communication (IPC). On other platforms, most notably
Windows and the combination of macOS with Python 3.8, subprocesses are
“spawned” instead of “forked”: The subprocesses start from a clean slate, and
all objects must be transfered from the parent process via IPC. This is very
slow, and you should not expect to be able to achieve any speedup from
parallelization on such platforms.</p>
<p>Another caveat on platforms using “spawn” is that certain objects by default
cannot be transferred via IPC, due to limitations of the <a class="reference external" href="https://docs.python.org/3.7/library/pickle.html#module-pickle" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pickle</span></code></a>
protocol. This affects <a class="reference external" href="https://docs.python.org/3.7/reference/expressions.html#lambda" title="(in Python v3.7)"><span>Lambdas</span></a> and functions defined in
Jupyter notebooks, in particular. The third-party <a class="reference external" href="https://loky.readthedocs.io/en/stable/API.html#module-loky" title="(in loky v3.4.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">loky</span></code></a> library provides
an alternative implementation for multi-processes parallelization that does not
have these restrictions, but causes even more overhead.</p>
<p>You may attempt to use the various options to <a class="reference internal" href="#krotov.parallelization.set_parallelization" title="krotov.parallelization.set_parallelization"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_parallelization()</span></code></a> in
order to find a combination of settings that minimizes the runtime in your
particular environment.</p>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>Classes:</p>
<table class="autosummary longtable docutils align-default">
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#krotov.parallelization.Consumer" title="krotov.parallelization.Consumer"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Consumer</span></code></a></p></td>
<td><p>A process-based task consumer.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#krotov.parallelization.FwPropStepTask" title="krotov.parallelization.FwPropStepTask"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FwPropStepTask</span></code></a></p></td>
<td><p>A task that performs a single forward-propagation step.</p></td>
</tr>
</tbody>
</table>
<p>Functions:</p>
<table class="autosummary longtable docutils align-default">
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#krotov.parallelization.parallel_map" title="krotov.parallelization.parallel_map"><code class="xref py py-obj docutils literal notranslate"><span class="pre">parallel_map</span></code></a></p></td>
<td><p>Map function <cite>task</cite> onto <cite>values</cite>, in parallel.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#krotov.parallelization.parallel_map_fw_prop_step" title="krotov.parallelization.parallel_map_fw_prop_step"><code class="xref py py-obj docutils literal notranslate"><span class="pre">parallel_map_fw_prop_step</span></code></a></p></td>
<td><p><cite>parallel_map</cite> function for the forward-propagation by one time step.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#krotov.parallelization.set_parallelization" title="krotov.parallelization.set_parallelization"><code class="xref py py-obj docutils literal notranslate"><span class="pre">set_parallelization</span></code></a></p></td>
<td><p>Configure multi-process parallelization.</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">__all__</span></code>: <a class="reference internal" href="#krotov.parallelization.Consumer" title="krotov.parallelization.Consumer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Consumer</span></code></a>, <a class="reference internal" href="#krotov.parallelization.FwPropStepTask" title="krotov.parallelization.FwPropStepTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">FwPropStepTask</span></code></a>, <a class="reference internal" href="#krotov.parallelization.parallel_map" title="krotov.parallelization.parallel_map"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallel_map</span></code></a>, <a class="reference internal" href="#krotov.parallelization.parallel_map_fw_prop_step" title="krotov.parallelization.parallel_map_fw_prop_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallel_map_fw_prop_step</span></code></a>, <a class="reference external" href="https://qutip.org/docs/4.5/apidoc/functions.html#qutip.parallel.serial_map" title="(in QuTiP: Quantum Toolbox in Python v4.5)"><code class="xref py py-func docutils literal notranslate"><span class="pre">serial_map</span></code></a>, <a class="reference internal" href="#krotov.parallelization.set_parallelization" title="krotov.parallelization.set_parallelization"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_parallelization</span></code></a></p>
</section>
<section id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Link to this heading">¶</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="krotov.parallelization.set_parallelization">
<span class="sig-prename descclassname"><span class="pre">krotov.parallelization.</span></span><span class="sig-name descname"><span class="pre">set_parallelization</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">use_loky</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">start_method</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">loky_pickler</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_threadpool_limits</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/krotov/parallelization.html#set_parallelization"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#krotov.parallelization.set_parallelization" title="Link to this definition">¶</a></dt>
<dd><p>Configure multi-process parallelization.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>use_loky</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#bool" title="(in Python v3.7)"><em>bool</em></a>) – Value for <a class="reference internal" href="#krotov.parallelization.USE_LOKY" title="krotov.parallelization.USE_LOKY"><code class="xref py py-obj docutils literal notranslate"><span class="pre">USE_LOKY</span></code></a>.</p></li>
<li><p><strong>start_method</strong> (<em>None</em><em> or </em><a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – One of ‘fork’, ‘spawn’, and ‘forkserver’,
see <a class="reference external" href="https://docs.python.org/3.7/library/multiprocessing.html#multiprocessing.set_start_method" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">multiprocessing.set_start_method()</span></code></a>. If <code class="docutils literal notranslate"><span class="pre">use_loky=True</span></code>,
also ‘loky’ and ‘loky_int_main’, see <a class="reference external" href="https://loky.readthedocs.io/en/stable/API.html#module-loky" title="(in loky v3.4.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">loky</span></code></a>. If None, a
platform and version-dependent default will be chosen automatically
(e.g., ‘fork’ on Linux, ‘spawn’ on Windows, ‘loky’ if
<code class="docutils literal notranslate"><span class="pre">use_loky=True</span></code>)</p></li>
<li><p><strong>loky_pickler</strong> (<em>None</em><em> or </em><a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – Serialization module to use for
<a class="reference external" href="https://loky.readthedocs.io/en/stable/API.html#module-loky" title="(in loky v3.4.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">loky</span></code></a>. One of ‘cloudpickle’, ‘pickle’. This forces the
serialization for <em>all</em> objects. The default value None chooses the
serialization automatically depending of the type of object. Using
‘cloudpickle’ is signficiantly slower than ‘pickle’ (but ‘pickle’
cannot serialize all objects, such as lambda functions or functions
defined in a Jupyter notebook).</p></li>
<li><p><strong>use_threadpool_limits</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#bool" title="(in Python v3.7)"><em>bool</em></a>) – Value for <a class="reference internal" href="#krotov.parallelization.USE_THREADPOOL_LIMITS" title="krotov.parallelization.USE_THREADPOOL_LIMITS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">USE_THREADPOOL_LIMITS</span></code></a>.</p></li>
</ul>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/3.7/library/exceptions.html#ImportError" title="(in Python v3.7)"><strong>ImportError</strong></a> – if <code class="docutils literal notranslate"><span class="pre">use_loky=True</span></code> but <a class="reference external" href="https://loky.readthedocs.io/en/stable/API.html#module-loky" title="(in loky v3.4.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">loky</span></code></a> is not installed.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When working in Jupyter notebooks on systems that use the ‘spawn’
<cite>start_method</cite> (Windows, or macOS with Python &gt;= 3.8), you may have to
use <a class="reference external" href="https://loky.readthedocs.io/en/stable/API.html#module-loky" title="(in loky v3.4.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">loky</span></code></a> (<code class="docutils literal notranslate"><span class="pre">use_loky=True</span></code>). This will incur a signficiant
increase in multi-processing overhead. Use Linux if you can.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This function should only be called once per script/notebook, at its
very beginning. The <a class="reference internal" href="#krotov.parallelization.USE_LOKY" title="krotov.parallelization.USE_LOKY"><code class="xref py py-obj docutils literal notranslate"><span class="pre">USE_LOKY</span></code></a> and <a class="reference internal" href="#krotov.parallelization.USE_THREADPOOL_LIMITS" title="krotov.parallelization.USE_THREADPOOL_LIMITS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">USE_THREADPOOL_LIMITS</span></code></a>
variables may be set at any time.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="krotov.parallelization.parallel_map">
<span class="sig-prename descclassname"><span class="pre">krotov.parallelization.</span></span><span class="sig-name descname"><span class="pre">parallel_map</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">task</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">values</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_args</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_kwargs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_cpus</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">progress_bar</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/krotov/parallelization.html#parallel_map"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#krotov.parallelization.parallel_map" title="Link to this definition">¶</a></dt>
<dd><p>Map function <cite>task</cite> onto <cite>values</cite>, in parallel.</p>
<p>This function’s interface is identical to
<a class="reference external" href="https://qutip.org/docs/4.5/apidoc/functions.html#qutip.parallel.parallel_map" title="(in QuTiP: Quantum Toolbox in Python v4.5)"><code class="xref py py-func docutils literal notranslate"><span class="pre">qutip.parallel.parallel_map()</span></code></a> as of QuTiP 4.5.0, but has the option
of using <a class="reference external" href="https://loky.readthedocs.io/en/stable/API.html#module-loky" title="(in loky v3.4.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">loky</span></code></a> as a backend (see <a class="reference internal" href="#krotov.parallelization.set_parallelization" title="krotov.parallelization.set_parallelization"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_parallelization()</span></code></a>). It
also eliminates internal threads, according to
<a class="reference internal" href="#krotov.parallelization.USE_THREADPOOL_LIMITS" title="krotov.parallelization.USE_THREADPOOL_LIMITS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">USE_THREADPOOL_LIMITS</span></code></a>.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="krotov.parallelization.Consumer">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">krotov.parallelization.</span></span><span class="sig-name descname"><span class="pre">Consumer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">task_queue</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">result_queue</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/krotov/parallelization.html#Consumer"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#krotov.parallelization.Consumer" title="Link to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference external" href="https://docs.python.org/3.7/library/multiprocessing.html#multiprocessing.Process" title="(in Python v3.7)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Process</span></code></a></p>
<p>A process-based task consumer.</p>
<p>This is for internal use in <a class="reference internal" href="#krotov.parallelization.parallel_map_fw_prop_step" title="krotov.parallelization.parallel_map_fw_prop_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallel_map_fw_prop_step()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>task_queue</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/multiprocessing.html#multiprocessing.JoinableQueue" title="(in Python v3.7)"><em>multiprocessing.JoinableQueue</em></a>) – A queue from which to read
tasks.</p></li>
<li><p><strong>result_queue</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/multiprocessing.html#multiprocessing.Queue" title="(in Python v3.7)"><em>multiprocessing.Queue</em></a>) – A queue where to put the results
of a task</p></li>
<li><p><strong>data</strong> – cached (in-process) data that will be passed to each task</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="krotov.parallelization.Consumer.run">
<span class="sig-name descname"><span class="pre">run</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/krotov/parallelization.html#Consumer.run"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#krotov.parallelization.Consumer.run" title="Link to this definition">¶</a></dt>
<dd><p>Execute all tasks on the <cite>task_queue</cite>.</p>
<p>Each task must be a callable that takes <cite>data</cite> as its only argument.
The return value of the task will be put on the <cite>result_queue</cite>. A None
value on the <cite>task_queue</cite> acts as a “poison pill”, causing the
<a class="reference internal" href="#krotov.parallelization.Consumer" title="krotov.parallelization.Consumer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Consumer</span></code></a> process to shut down.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="krotov.parallelization.FwPropStepTask">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">krotov.parallelization.</span></span><span class="sig-name descname"><span class="pre">FwPropStepTask</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">i_state</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pulse_vals</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">time_index</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/krotov/parallelization.html#FwPropStepTask"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#krotov.parallelization.FwPropStepTask" title="Link to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference external" href="https://docs.python.org/3.7/library/functions.html#object" title="(in Python v3.7)"><code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></a></p>
<p>A task that performs a single forward-propagation step.</p>
<p>The task object is a callable, receiving the single tuple of the same
form as <cite>task_args</cite> in <a class="reference internal" href="#krotov.parallelization.parallel_map_fw_prop_step" title="krotov.parallelization.parallel_map_fw_prop_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallel_map_fw_prop_step()</span></code></a> as input. This
<cite>data</cite> is internally cached by the <a class="reference internal" href="#krotov.parallelization.Consumer" title="krotov.parallelization.Consumer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Consumer</span></code></a> that will execute
the task.</p>
<p>This is for internal use in <a class="reference internal" href="#krotov.parallelization.parallel_map_fw_prop_step" title="krotov.parallelization.parallel_map_fw_prop_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallel_map_fw_prop_step()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>i_state</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#int" title="(in Python v3.7)"><em>int</em></a>) – The index of the state to propagation. That is, the
index of the objective from whose <a class="reference internal" href="krotov.objectives.html#krotov.objectives.Objective.initial_state" title="krotov.objectives.Objective.initial_state"><code class="xref py py-attr docutils literal notranslate"><span class="pre">initial_state</span></code></a>
the propagation started</p></li>
<li><p><strong>pulse_vals</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#list" title="(in Python v3.7)"><em>list</em></a><em>[</em><a class="reference external" href="https://docs.python.org/3.7/library/functions.html#float" title="(in Python v3.7)"><em>float</em></a><em>]</em>) – the values of the pulses at <cite>time_index</cite> to
use.</p></li>
<li><p><strong>time_index</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#int" title="(in Python v3.7)"><em>int</em></a>) – the index of the interval on the time grid covered by
the propagation step</p></li>
</ul>
</dd>
</dl>
<p>The passed arguments update the internal state (<cite>data</cite>) of the
<a class="reference internal" href="#krotov.parallelization.Consumer" title="krotov.parallelization.Consumer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Consumer</span></code></a> executing the task; they are the minimal information that
must be passed via inter-process communication to enable the forward
propagation (assuming <cite>propagate</cite> in <a class="reference internal" href="krotov.optimize.html#krotov.optimize.optimize_pulses" title="krotov.optimize.optimize_pulses"><code class="xref py py-func docutils literal notranslate"><span class="pre">optimize_pulses()</span></code></a> has no
side-effects)</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="krotov.parallelization.parallel_map_fw_prop_step">
<span class="sig-prename descclassname"><span class="pre">krotov.parallelization.</span></span><span class="sig-name descname"><span class="pre">parallel_map_fw_prop_step</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">shared</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">values</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_args</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/krotov/parallelization.html#parallel_map_fw_prop_step"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#krotov.parallelization.parallel_map_fw_prop_step" title="Link to this definition">¶</a></dt>
<dd><p><cite>parallel_map</cite> function for the forward-propagation by one time step.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>shared</strong> – A global object to which we can attach attributes for sharing
data between different calls to <a class="reference internal" href="#krotov.parallelization.parallel_map_fw_prop_step" title="krotov.parallelization.parallel_map_fw_prop_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallel_map_fw_prop_step()</span></code></a>,
allowing us to have long-running <a class="reference internal" href="#krotov.parallelization.Consumer" title="krotov.parallelization.Consumer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Consumer</span></code></a> processes,
avoiding process-management overhead.
This happens to be a callable (the original internal routine for
performing a forward-propagation), but here, it is (ab-)used as a
storage object only.</p></li>
<li><p><strong>values</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#list" title="(in Python v3.7)"><em>list</em></a>) – a list 0..(N-1) where N is the number of objectives</p></li>
<li><p><strong>task_args</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#tuple" title="(in Python v3.7)"><em>tuple</em></a>) – <p>A tuple of 7 components:</p>
<ol class="arabic simple">
<li><p>A list of states to propagate, one for each objective.</p></li>
<li><p>The list of objectives</p></li>
<li><p>The list of optimized pulses (updated up to <cite>time_index</cite>)</p></li>
<li><p>The “pulses mapping”, cf <a class="reference internal" href="krotov.conversions.html#krotov.conversions.extract_controls_mapping" title="krotov.conversions.extract_controls_mapping"><code class="xref py py-func docutils literal notranslate"><span class="pre">extract_controls_mapping()</span></code></a></p></li>
<li><p>The list of time grid points</p></li>
<li><p>The index of the interval on the time grid over which to
propagate</p></li>
<li><p>A list of <cite>propagate</cite> callables, as passed to
<a class="reference internal" href="krotov.optimize.html#krotov.optimize.optimize_pulses" title="krotov.optimize.optimize_pulses"><code class="xref py py-func docutils literal notranslate"><span class="pre">optimize_pulses()</span></code></a>.  The propagators must not have
side-effects in order for <a class="reference internal" href="#krotov.parallelization.parallel_map_fw_prop_step" title="krotov.parallelization.parallel_map_fw_prop_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallel_map_fw_prop_step()</span></code></a> to
work correctly.</p></li>
</ol>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="krotov.parallelization.USE_LOKY">
<span class="sig-prename descclassname"><span class="pre">krotov.parallelization.</span></span><span class="sig-name descname"><span class="pre">USE_LOKY</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">False</span></em><a class="headerlink" href="#krotov.parallelization.USE_LOKY" title="Link to this definition">¶</a></dt>
<dd><p>Whether to use <a class="reference external" href="https://loky.readthedocs.io/en/stable/API.html#module-loky" title="(in loky v3.4.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">loky</span></code></a> instead of <a class="reference external" href="https://docs.python.org/3.7/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multiprocessing</span></code></a>.</p>
<p>Set by <a class="reference internal" href="#krotov.parallelization.set_parallelization" title="krotov.parallelization.set_parallelization"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_parallelization()</span></code></a>.</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="krotov.parallelization.USE_THREADPOOL_LIMITS">
<span class="sig-prename descclassname"><span class="pre">krotov.parallelization.</span></span><span class="sig-name descname"><span class="pre">USE_THREADPOOL_LIMITS</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">True</span></em><a class="headerlink" href="#krotov.parallelization.USE_THREADPOOL_LIMITS" title="Link to this definition">¶</a></dt>
<dd><p>Whether to limit the number of low-level BLAS/OpenMP threads.</p>
<p>When using multi-process parallelization, <em>nested parallelization</em> must be
avoided. That is, low-level numerical routines e.g. in <a class="reference external" href="https://numpy.org/doc/stable/reference/index.html#module-numpy" title="(in NumPy v2.2)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy</span></code></a> should not
be allowed to use multiple threads. This would lead to over-subscribing CPUs
and can slow down the entire program by orders of magnitude.</p>
<p>If True, <a class="reference external" href="https://github.com/joblib/threadpoolctl">threadpoolctl</a> will be used internally to attempt to eliminate any
nested threads.</p>
<p>Set by <a class="reference internal" href="#krotov.parallelization.set_parallelization" title="krotov.parallelization.set_parallelization"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_parallelization()</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Alternatively (or in addition), you may want to consider setting the
following environment variables in your shell:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">MKL_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NUMEXPR_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div>
</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="krotov.optimize.html" class="btn btn-neutral float-left" title="krotov.optimize module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="krotov.propagators.html" class="btn btn-neutral float-right" title="krotov.propagators module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Michael Goerz et al..
      <span class="lastupdated">Last updated on Feb 25, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>